@model MvcPhoenix.Models.OrderTrans
@using MvcPhoenix.Models;
@using MvcPhoenix.Services;

<div id="widget001">
    @{
        Model.orderid = Convert.ToInt32(Session["OrderID"]);
        MvcPhoenix.EF.CMCSQL03Entities widget001_db = new MvcPhoenix.EF.CMCSQL03Entities();
        var qry1 = widget001_db.tblOrderMaster.First(t => t.OrderID == Model.orderid);
        Model.clientid = qry1.ClientID;
        if (Model.qryfilter == "") { Model.qryfilter = "All"; }

        var qryrows = (from t in widget001_db.tblOrderTrans
                       join items in widget001_db.tblOrderItem on t.OrderItemID equals items.ItemID into mytables
                       from final in mytables.DefaultIfEmpty()
                       where t.OrderID == Model.orderid
                       orderby t.TransType
                       select new
                       {
                           t.OrderTransID,
                           t.ClientID,
                           t.OrderID,
                           t.OrderItemID,
                           t.UserID,
                           t.TransType,
                           t.TransDate,
                           t.TransQty,
                           t.TransAmount,
                           t.Comments,
                           final.ProductName,
                           final.ProductCode
                       }).ToList();

        if (Model.qryfilter == "All")
        {
            var qry1rows = (from t in widget001_db.tblOrderTrans
                            join items in widget001_db.tblOrderItem on t.OrderItemID equals items.ItemID into mytables
                            from final in mytables.DefaultIfEmpty()
                            where t.OrderID == Model.orderid
                            orderby t.TransType
                            select new
                            {
                                t.OrderTransID,
                                t.ClientID,
                                t.OrderID,
                                t.OrderItemID,
                                t.UserID,
                                t.TransType,
                                t.TransDate,
                                t.TransQty,
                                t.TransAmount,
                                t.Comments,
                                final.ProductName,
                                final.ProductCode
                            }).ToList();
            qryrows = qry1rows;
        }
        else if (Model.qryfilter == "OrderOnly")
        {
            var qry2rows = (from t in widget001_db.tblOrderTrans
                            join items in widget001_db.tblOrderItem on t.OrderItemID equals items.ItemID into mytables
                            from final in mytables.DefaultIfEmpty()
                            where t.OrderID == Model.orderid && (t.OrderItemID == 0 || t.OrderItemID == null)
                            orderby t.TransType
                            select new
                            {
                                t.OrderTransID,
                                t.ClientID,
                                t.OrderID,
                                t.OrderItemID,
                                t.UserID,
                                t.TransType,
                                t.TransDate,
                                t.TransQty,
                                t.TransAmount,
                                t.Comments,
                                final.ProductName,
                                final.ProductCode
                            }).ToList();
            qryrows = qry2rows;
        }
        widget001_db.Dispose();
    }
    <!-- Modal placeholder for edit interface in partial -->
    <!-- IMPORTANT: add a <div> into the modal-body and use that as AJAX targetid  -->
    <div class="modal" id="transmodal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <div id="modal100" style="background-color:white;">
                        @Html.Partial("~/Views/Orders/_TransEditModal.cshtml", new MvcPhoenix.Models.OrderTrans())
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div>
        <span class="pull-left" style="padding-bottom: 20px;">
            @Ajax.ActionLink("Add a transaction to this order", "SetUpNewOrderTrans", "Orders", null,
                    new AjaxOptions
                    {
                        UpdateTargetId = "modal100",
                        InsertionMode = InsertionMode.Replace,
                        HttpMethod = "GET",
                        OnSuccess = "$('#transmodal').modal('show');"
                    }, new { @class = "btn btn-primary" })
        </span>
        <span class="pull-right">
            <b>Transaction Count:</b> @qryrows.Count
        </span>
    </div>
    <div class="clearfix"></div>

    <div class="table-responsive">
        <table class="table table-hover table-striped" style="font-size:.85em;margin:auto;">
            <tr>
                <th><i class="fa fa-fw fa-trash-o"></i></th>
                <th>Date</th>
                <th>Type</th>
                <th>Product Code</th>
                <th>Name</th>
                <th style="text-align:center;">Qty</th>
                <th style="text-align:right;">Amount</th>
                <th style="text-align:center;">User</th>
                <th>Comments</th>
                <th class="text-center"><i class="fa fa-fw fa-pencil-square-o"></i></th>
            </tr>
            @foreach (var item in qryrows)
            {
                <tr>
                    <td>
                        <a title="Delete" data-ajax="true" data-ajax-confirm="Are you sure you want to DELETE this entry?" data-ajax-method="GET" data-ajax-mode="replace"
                           data-ajax-update="#widget001" href="~/Orders/QuickDeleteOrderTrans?OrderTransID=@item.OrderTransID"><i class="fa fa-fw fa-minus-circle" style="color:red"></i></a>
                    </td>
                    <td>@item.TransDate.ToString()</td>
                    <td>@item.TransType</td>
                    <td>@item.ProductCode</td>
                    <td>@item.ProductName</td>
                    <td class="text-center">@item.TransQty</td>
                    <td class="text-right">@item.TransAmount</td>
                    <td class="text-center">@item.UserID</td>
                    <td>@item.Comments</td>
                    <td class="text-center">
                        @Ajax.ActionLink("Edit", "SetUpEditOrderTrans", "Orders", new { OrderTransID = @item.OrderTransID }, new AjaxOptions
                             {
                                 UpdateTargetId = "modal100",
                                 InsertionMode = InsertionMode.Replace,
                                 HttpMethod = "GET",
                                 OnSuccess = "$('#transmodal').modal('show');"
                             },
                           new { @class = "btn btn-xs btn-primary" })
                    </td>
                </tr>
            }
        </table>
    </div>
</div>